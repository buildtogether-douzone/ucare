<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="patient">	
	<insert id="create" parameterType="patientvo">
		INSERT
			INTO ucare.patient(name, ssn, age, gender, tel_no, address, email, insurance_yn, diagnosis_type, visit_date, remark, ins_dt, user_no)
		VALUES(
			#{name },
			#{ssn },
			#{age },
			#{gender },
			#{telNo },
			#{address },
			#{domain },
			#{insurance },
			#{diagnosis },
			TO_DATE(#{visitDate },'YYYY-MM-DD'),
			#{remark },
			TO_DATE(#{visitDate },'YYYY-MM-DD'),
			(SELECT user_no FROM ucare.user WHERE id = #{userId } )
		)
	</insert>
	
	<select id="retrieveAll" resultType="patientvo" >
		SELECT 
			patient_no AS patientNo, 
			name,
			(gender||'/'||age) AS ageGender,
			age AS age,
			gender AS gender,
			CONCAT(SUBSTR(ssn, 1, 8), '******') AS ssn,
			tel_no AS telNo,
			SUBSTR(address, 1, 13) AS address,
			insurance_yn AS insurance,
			diagnosis_type AS diagnosis,
			ins_dt AS insDt,
		   split_part(email, '@', 1) as emailId,
		   split_part(email, '@', 2) as email,
		   remark AS remark
		FROM ucare.patient
		ORDER BY patient_no desc
	</select>
	
	<select id="findUser" parameterType="patientvo" resultType="patientvo">
		SELECT id,
			   name
		FROM ucare.user
		WHERE id = #{id }
		  AND password = #{password }
	</select>
	
	<select id="findByID" parameterType="patientvo" resultType="patientvo">
		SELECT name,
			   password,
			   tel_no AS telNo,
			   split_part(email, '@', 1) as emailId,
			   split_part(email, '@', 2) as email,
			   address,
			   birth
		FROM ucare.user
		WHERE id = #{id }
	</select>
	
	<update id="updateUser" parameterType="uservo">
			UPDATE  ucare.user
			   SET 
			   		name = #{name },
			   		<if test="password != null and password != '' ">
			   		password = #{password },
			   		</if>
			   		tel_no = #{telNo },
			   		email = #{email },
			   		address = #{address },
			   		birth = TO_DATE(#{birth },'YYYY-MM-DD'),
			   		image = #{image }
			WHERE id = #{id }
	</update>
	
	<update id="update" parameterType="diseasevo">
			UPDATE  ucare.disease
			   SET 
			   		disease_nm = #{diseaseNm },
			   		symptom = #{symptom }
			WHERE disease_no = #{diseaseNo }
	</update>
	
	<delete id="delete" parameterType="int">
		DELETE
		  FROM ucare.disease
		 WHERE disease_no = #{diseaseNo }
	</delete>

</mapper>
